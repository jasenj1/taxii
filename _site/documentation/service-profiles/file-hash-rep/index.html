<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>File Hash Reputation | TAXII Project Documentation</title>
    <meta name="viewport" content="width=device-width">

    <!-- bootstrap CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-35443076-1']);
      _gaq.push(['_setDomainName', 'taxiiproject.github.io'])
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

</head>

  <body>

    <div class="navbar navbar-inverse navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">TAXII Docs</a>
    </div>
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav">
          <li role="presentation"><a href="/getting-started">Getting Started</a></li>
          <!-- <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Getting Started<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">

            <li role="presentation" class="divider"></li>
            <li role="presentation" class="dropdown-header">Documents</li>
            <li role="presentation"><a href="http://makingsecuritymeasurable.mitre.org/docs/taxii-intro-handout.pdf" target="_blank">Introductory Brochure</a></li>
            <li role="presentation"><a href="http://taxii.mitre.org/about/documents/Introduction_to_TAXII_White_Paper_May_2014.pdf" target="_blank">Whitepaper (PDF)</a></li>
            <li role="presentation"><a href="http://stix.mitre.org/training/" target="_blank">Training Materials</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a href="/documentation">Documentation Home</a></li>
            <li role="presentation"><a href="/developers">Developers Home</a></li>
            <!-- <li role="presentation" class="dropdown-header">TAXII Libraries</li>
            <li role="presentation"><a href="http://libtaxii.readthedocs.org/en/latest/getting_started.html">libtaxii</a></li>
            <li role="presentation"><a href="http://taxii-services.readthedocs.org/en/latest/getting_started.html">django-taxii-services</a></li>
            <li role="presentation"><a href="/java-taxii/getting-started">java-taxii</a></li>
            <li role="presentation"><a href="https://github.com/TAXIIProject/yeti">YETI</a></li>
          </ul>
        </li> -->

        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation<span class="caret"></span></a>
          <ul class="dropdown-menu" role="menu">
            <li role="presentation"><a href="/documentation">Documentation Home</a></li>
            <li role="presentation" class="divider"></li>
            <li role="presentation"><a href="/documentation/service-profiles">TAXII Service Profiles</a></li>
            <li role="presentation"><a href="/documentation/faq">TAXII FAQ</a></li>
          </ul>
        </li>

        <li class="dropdown">
         <a href="#" class="dropdown-toggle" data-toggle="dropdown">Developers<span class="caret"></span></a>
         <ul class="dropdown-menu" role="menu">
           <li role="presentation"><a href="/developers">Developers Home</a></li>
           <li role="presentation" class="divider"></li>
           <li role="presentation"><a href="/developers/libtaxii">libtaxii</a></li>
           <li role="presentation"><a href="/developers/taxii-services">django-taxii-services</a></li>
           <li role="presentation"><a href="/developers/java-taxii">java-taxii</a></li>
         </ul>
        </li>

    </div>
  </div>
</div>


    <div class="container">
      <h1>File Hash Reputation</h1>
      <p>A File Hash Reputation service allows requesters to specify a File Hash and receive a confidence assertion about whether 
that File Hash indicates a malicious file - or, how confident information provider is that the file identified by that 
File Hash is malicious. This example
uses TAXII Query to convey the request for information based on a File Hash, and uses STIX to represent the
result. All code examples use <a href="/developers/libtaxii/">libtaxii</a> and 
<a href="http://stix.readthedocs.org/en/latest/">python-stix</a>, two publicly available libraries.</p>

<p>This TAXII Service Profile demonstrates the production and consumption of TAXII Messages, as well as the 
creation and &quot;use&quot; (big airquotes here - you&#39;ll see why at the end) of STIX content. 
This TAXII Service Profile does not demonstrate transmitting TAXII Messages across a network.</p>

<p>This documentation is from the perspective of the TAXII Server, called &quot;service provider&quot; in this documentation.</p>

<h2 id="requirements">Requirements</h2>

<p>These are the requirements to implement a File Hash Reputation Service as described in this TAXII Service Profile:</p>

<ol>
<li>Implement a Poll Service that supports TAXII Default Query</li>
<li><p>Have a Data Collection named <code>file_hash_reputation</code></p>

<ol>
<li>This Data Collection is a Data Set (as opposed to a Data Feed)</li>
</ol></li>
<li><p>Have a database that (nominally) contains the following information: </p>

<ol>
<li>File Hash (The MD5 hash of the file)</li>
<li>Confidence (The confidence that the file is malicious - High, Medium, Low, None, or Unknown)</li>
</ol></li>
<li><p>Use STIX as the Targeting Expression Vocabulary</p></li>
<li><p>Give yourself a name. This example uses &quot;Mark&#39;s Malware Metadata Mart&quot;</p></li>
</ol>

<p>For the sake of example, we&#39;ll assume that the table containing File Hash and Confidence is
a SQL Table that looks like the table below. The table is named <code>file_hash_reputation</code> and 
has an index on md5_hash.</p>

<table><thead>
<tr>
<th>md5_hash</th>
<th>confidence</th>
</tr>
</thead><tbody>
<tr>
<td>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</td>
<td>Low</td>
</tr>
<tr>
<td>BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB</td>
<td>Medium</td>
</tr>
<tr>
<td>CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC</td>
<td>High</td>
</tr>
</tbody></table>

<h2 id="stixification">STIXification</h2>

<p>When using STIX, there are factors that should be considered beyond just the data that will be represented. These 
factors include mapping your data to STIX, 
<a href="http://stixproject.github.io/documentation/concepts/versioning/">STIX Versioning</a>,and 
possibly other aspects as well. This section describes the &quot;STIXification&quot; of the above database. It is important to 
note that the STIXification step requires some knowledge of STIX. 
The STIXified version of <code>file_hash_reputation</code> is <code>file_hash_reputation_stixified</code></p>

<h3 id="stixification---mapping">STIXification - Mapping</h3>

<p>An important step is mapping source information to STIX. There are some good resources to assist in this mapping, 
including the <a href="http://stixproject.github.io/documentation/">STIX Documentation</a>; 
the idioms may be of particular interest here. Without getting into
the nitty gritty of the mapping, a few high-level decisions are important to call out:</p>

<ul>
<li>File Hash will be represented as a File Object observable in an Indicator</li>
<li>The Indicator will have an Indicated TTP</li>
<li>The Indicated TTP will indicate &quot;Malicious File&quot;</li>
<li>A Confidence relationship between the Indicator and the Indicated TTP will assert how confident Mark&#39;s Malware
Metadata Mart is that the file is malicious

<ul>
<li>The confidence value will be one of High, Medium Low, None, or Unknown.</li>
</ul></li>
</ul>

<h3 id="stixification---versioning">STIXification - Versioning</h3>

<p>In addition to MD5 Hash and Confidence, an implementation needs to keep track of certain versioning information. 
This information includes ID and timestamp for the Indicator and
TTP constructs; the ID for the Observable, and Object constructs; and the timestamp for the confidence assertion.</p>

<p>For this example File Hash Reputation implementation, there are certain values that can be &quot;hard coded&quot;. Those values are:</p>

<ul>
<li>id namespace = &quot;urn:example.com:marks_malware_metadata_mart&quot;</li>
<li>id namespace alias = &quot;m4&quot;</li>
<li>TTP ID: <code>ttp-d539bb85-9363-4814-83c8-fa9975045686</code></li>
<li>TTP Timestamp: <code>2014-09-30T15:56:27.000000+00:00</code></li>
</ul>

<p>Other values will be different for each file hash. Those values are described in the following table:</p>

<table><thead>
<tr>
<th>md5_hash</th>
<th>object_id (local part)</th>
<th>observable_id (local part)</th>
<th>confidence</th>
<th>confidence_timestamp</th>
<th>indicator_id (local part)</th>
<th>indicator_timestamp</th>
</tr>
</thead><tbody>
<tr>
<td>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</td>
<td>File-927731f2-cc2c-421c-a40e-dc6f4a6c75a4</td>
<td>Observable-45e3e64c-8438-441e-bc49-51e417466e29</td>
<td>High</td>
<td>2014-09-29T14:32:00.000000</td>
<td>Indicator-54baefc1-4742-4b40-ba83-afd51115015b</td>
<td>2014-09-29T14:32:00.000000</td>
</tr>
</tbody></table>

<h3 id="stixification---conclusion">STIXification - Conclusion</h3>

<p>A tabular view of the mapping decisions: </p>

<table><thead>
<tr>
<th>database field</th>
<th>STIX Construct</th>
</tr>
</thead><tbody>
<tr>
<td>md5_hash</td>
<td>Indicator\Observable\Object\Properties\Hashes\Hash\Simple_Hash_Value</td>
</tr>
<tr>
<td>object_id</td>
<td>Indicator\Observable\Object\@id</td>
</tr>
<tr>
<td>observable_id</td>
<td>Indicator\Observable\@id</td>
</tr>
<tr>
<td>confidence</td>
<td>Indicator\Indicated_TTP\Confidence\Value</td>
</tr>
<tr>
<td>confidence_timestamp</td>
<td>Indicator\Indicated_TTP\Confidence\@timestamp</td>
</tr>
<tr>
<td>indicator_id</td>
<td>Indicator\@id</td>
</tr>
<tr>
<td>indicator_timestamp</td>
<td>Indicator\@timestamp</td>
</tr>
</tbody></table>

<p>Massaging the database into a STIXified version will help greatly with future steps. One thing that should be
noted is that the <code>file_hash_reputation_stixified</code> database table only supports the File Hash Reputation use case. 
Supporting additional use cases would likely result in a refactor/rearchitecture of the database.</p>

<h2 id="workflow">Workflow</h2>

<p>The workflow for this Service Profile is:</p>

<ol>
<li><a href="#1"><strong>Discovery:</strong></a> The service provider responds to a request for discovery</li>
<li><a href="#2"><strong>Poll Request:</strong></a> The service provider receives a Poll Request with a TAXII Default Query</li>
<li><a href="#3"><strong>Inbound Mapping:</strong></a> The service provider maps the TAXII Default Query into a query for the 
service provider&#39;s database</li>
<li><a href="#4"><strong>Database Query:</strong></a> The service provider executes the query against the service provider&#39;s database</li>
<li><a href="#5"><strong>Outbound Mapping:</strong></a> The service provider maps the database result set into STIX</li>
<li><a href="#6"><strong>Poll Response:</strong></a> The service provider packages up the STIX into a Poll Response and return it</li>
<li><a href="#7"><strong>Parse Response</strong></a> The recipient of information parses the response</li>
</ol>

<h3 id="step-1---discovery"><a name="1"></a>Step 1 - Discovery</h3>

<p>The service provider receives a Discovery Request and responds with a Discovery Response that details
the service provider&#39;s capabilities.</p>

<h4 id="discovery-request---xml">Discovery Request - XML</h4>

<p>The Discovery Request sent to the service provider to discover capabilities. </p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno">1</span> <span class="nt">&lt;taxii_11:Discovery_Request</span>  
<span class="lineno">2</span>     <span class="na">xmlns:taxii_11=</span><span class="s">&quot;http://taxii.mitre.org/messages/taxii_xml_binding-1.1&quot;</span> 
<span class="lineno">3</span>     <span class="na">message_id=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span></code></pre></div>

<p><a href="file-hash-rep-discovery-request.xml">XML Source</a></p>

<h4 id="discovery-request---python">Discovery Request - Python</h4>

<p>Python code to create the Discovery Request.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno">1</span> <span class="kn">import</span> <span class="nn">libtaxii.messages_11</span> <span class="kn">as</span> <span class="nn">tm11</span>
<span class="lineno">2</span> <span class="n">dr</span> <span class="o">=</span> <span class="n">tm11</span><span class="o">.</span><span class="n">DiscoveryRequest</span><span class="p">(</span><span class="n">message_id</span><span class="o">=</span><span class="s">&quot;1&quot;</span><span class="p">)</span>
<span class="lineno">3</span> <span class="k">print</span> <span class="n">dr</span><span class="o">.</span><span class="n">to_xml</span><span class="p">(</span><span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>

<p><a href="file-hash-rep-discovery-request.py">Python Source</a></p>

<h4 id="discovery-response---xml">Discovery Response - XML</h4>

<p>The Discovery Response sent by the service provider detailing capabilities.</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno"> 1</span> <span class="nt">&lt;taxii_11:Discovery_Response</span> 
<span class="lineno"> 2</span>     <span class="na">xmlns:taxii_11=</span><span class="s">&quot;http://taxii.mitre.org/messages/taxii_xml_binding-1.1&quot;</span> 
<span class="lineno"> 3</span>     <span class="na">xmlns:tdq=</span><span class="s">&quot;http://taxii.mitre.org/query/taxii_default_query-1&quot;</span> 
<span class="lineno"> 4</span>     <span class="na">message_id=</span><span class="s">&quot;25984&quot;</span> 
<span class="lineno"> 5</span>     <span class="na">in_response_to=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="lineno"> 6</span>   <span class="nt">&lt;taxii_11:Service_Instance</span> <span class="na">service_type=</span><span class="s">&quot;POLL&quot;</span> <span class="na">service_version=</span><span class="s">&quot;urn:taxii.mitre.org:services:1.1&quot;</span> <span class="na">available=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<span class="lineno"> 7</span>     <span class="nt">&lt;taxii_11:Protocol_Binding&gt;</span>urn:taxii.mitre.org:protocol:http:1.0<span class="nt">&lt;/taxii_11:Protocol_Binding&gt;</span>
<span class="lineno"> 8</span>     <span class="nt">&lt;taxii_11:Address&gt;</span>http://example.com/poll-service/<span class="nt">&lt;/taxii_11:Address&gt;</span>
<span class="lineno"> 9</span>     <span class="nt">&lt;taxii_11:Message_Binding&gt;</span>urn:taxii.mitre.org:message:xml:1.1<span class="nt">&lt;/taxii_11:Message_Binding&gt;</span>
<span class="lineno">10</span>     <span class="nt">&lt;taxii_11:Supported_Query</span> <span class="na">format_id=</span><span class="s">&quot;urn:taxii.mitre.org:query:default:1.0&quot;</span><span class="nt">&gt;</span>
<span class="lineno">11</span>       <span class="nt">&lt;tdq:Default_Query_Info&gt;</span>
<span class="lineno">12</span>         <span class="nt">&lt;tdq:Targeting_Expression_Info</span> <span class="na">targeting_expression_id=</span><span class="s">&quot;urn:stix.mitre.org:xml:1.1.1&quot;</span><span class="nt">&gt;</span>
<span class="lineno">13</span>           <span class="nt">&lt;tdq:Preferred_Scope&gt;</span>**/Simple_Hash_Value<span class="nt">&lt;/tdq:Preferred_Scope&gt;</span>
<span class="lineno">14</span>         <span class="nt">&lt;/tdq:Targeting_Expression_Info&gt;</span>
<span class="lineno">15</span>         <span class="nt">&lt;tdq:Capability_Module&gt;</span>urn:taxii.mitre.org:query:capability:core-1<span class="nt">&lt;/tdq:Capability_Module&gt;</span>
<span class="lineno">16</span>       <span class="nt">&lt;/tdq:Default_Query_Info&gt;</span>
<span class="lineno">17</span>     <span class="nt">&lt;/taxii_11:Supported_Query&gt;</span>
<span class="lineno">18</span>     <span class="nt">&lt;taxii_11:Message&gt;</span>This is a File Hash Reputation Poll Service<span class="nt">&lt;/taxii_11:Message&gt;</span>
<span class="lineno">19</span>   <span class="nt">&lt;/taxii_11:Service_Instance&gt;</span>
<span class="lineno">20</span> <span class="nt">&lt;/taxii_11:Discovery_Response&gt;</span></code></pre></div>

<p><a href="file-hash-rep-discovery-response.xml">XML Source</a></p>

<h4 id="discovery-response---python">Discovery Response - Python</h4>

<p>Python code to create the Discovery Response.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="n">discovery_response</span> <span class="o">=</span> <span class="n">tm11</span><span class="o">.</span><span class="n">DiscoveryResponse</span><span class="p">(</span><span class="n">message_id</span> <span class="o">=</span> <span class="n">generate_message_id</span><span class="p">(),</span>
<span class="lineno"> 2</span>                                             <span class="n">in_response_to</span> <span class="o">=</span> <span class="s">&#39;1&#39;</span><span class="p">)</span>
<span class="lineno"> 3</span> 
<span class="lineno"> 4</span> <span class="c"># Create a targeting expression info </span>
<span class="lineno"> 5</span> <span class="c"># indicating STIX XML 1.1.1 and that only </span>
<span class="lineno"> 6</span> <span class="c"># Hash Value targets are allowed</span>
<span class="lineno"> 7</span> <span class="n">my_tei</span> <span class="o">=</span> <span class="n">tdq</span><span class="o">.</span><span class="n">TargetingExpressionInfo</span><span class="p">(</span><span class="n">CB_STIX_XML_111</span><span class="p">,</span>
<span class="lineno"> 8</span>                                      <span class="n">preferred_scope</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;**/Simple_Hash_Value&#39;</span><span class="p">],</span>
<span class="lineno"> 9</span>                                      <span class="n">allowed_scope</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="lineno">10</span> 
<span class="lineno">11</span> <span class="n">my_supported_query</span> <span class="o">=</span> <span class="n">tdq</span><span class="o">.</span><span class="n">DefaultQueryInfo</span><span class="p">([</span><span class="n">my_tei</span><span class="p">],</span> <span class="p">[</span><span class="n">CM_CORE</span><span class="p">])</span>
<span class="lineno">12</span> 
<span class="lineno">13</span> <span class="n">si</span> <span class="o">=</span> <span class="n">tm11</span><span class="o">.</span><span class="n">ServiceInstance</span><span class="p">(</span>
<span class="lineno">14</span>                 <span class="n">service_type</span> <span class="o">=</span> <span class="n">SVC_POLL</span><span class="p">,</span>
<span class="lineno">15</span>                 <span class="n">services_version</span> <span class="o">=</span> <span class="n">VID_TAXII_SERVICES_11</span><span class="p">,</span>
<span class="lineno">16</span>                 <span class="n">protocol_binding</span> <span class="o">=</span> <span class="n">VID_TAXII_HTTP_10</span><span class="p">,</span>
<span class="lineno">17</span>                 <span class="n">service_address</span> <span class="o">=</span> <span class="s">&#39;http://example.com/poll-service/&#39;</span><span class="p">,</span>
<span class="lineno">18</span>                 <span class="n">message_bindings</span> <span class="o">=</span> <span class="p">[</span><span class="n">VID_TAXII_XML_11</span><span class="p">],</span>
<span class="lineno">19</span>                 <span class="n">available</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
<span class="lineno">20</span>                 <span class="n">message</span> <span class="o">=</span> <span class="s">&#39;This is a File Hash Reputation Poll Service&#39;</span><span class="p">,</span>
<span class="lineno">21</span>                 <span class="n">supported_query</span> <span class="o">=</span> <span class="p">[</span><span class="n">my_supported_query</span><span class="p">])</span>
<span class="lineno">22</span> 
<span class="lineno">23</span> <span class="n">discovery_response</span><span class="o">.</span><span class="n">service_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">si</span><span class="p">)</span>
<span class="lineno">24</span> 
<span class="lineno">25</span> <span class="k">print</span> <span class="n">discovery_response</span><span class="o">.</span><span class="n">to_xml</span><span class="p">(</span><span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>

<p><a href="file-hash-rep-discovery-response.py">Python Source</a></p>

<h3 id="step-2---poll-request"><a name="2"></a>Step 2 - Poll Request</h3>

<p>The service provider receives a Poll Request containing the query to fulfill. The service provider will parse the 
Poll Request and provide a Poll Response. </p>

<h4 id="poll-request---xml">Poll Request - XML</h4>

<p>The Poll Request containing a query sent to the service provider. </p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno"> 1</span> <span class="nt">&lt;taxii_11:Poll_Request</span>
<span class="lineno"> 2</span>         <span class="na">xmlns:taxii_11=</span><span class="s">&quot;http://taxii.mitre.org/messages/taxii_xml_binding-1.1&quot;</span>
<span class="lineno"> 3</span>         <span class="na">xmlns:tdq=</span><span class="s">&quot;http://taxii.mitre.org/query/taxii_default_query-1&quot;</span>
<span class="lineno"> 4</span>         <span class="na">message_id=</span><span class="s">&quot;55134&quot;</span> <span class="na">collection_name=</span><span class="s">&quot;file_hash_reputation&quot;</span><span class="nt">&gt;</span>
<span class="lineno"> 5</span>   <span class="nt">&lt;taxii_11:Poll_Parameters</span> <span class="na">allow_asynch=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<span class="lineno"> 6</span>     <span class="nt">&lt;taxii_11:Response_Type&gt;</span>FULL<span class="nt">&lt;/taxii_11:Response_Type&gt;</span>
<span class="lineno"> 7</span>     <span class="nt">&lt;taxii_11:Content_Binding</span> <span class="na">binding_id=</span><span class="s">&quot;urn:stix.mitre.org:xml:1.1.1&quot;</span><span class="nt">/&gt;</span>
<span class="lineno"> 8</span>     <span class="nt">&lt;taxii_11:Query</span> <span class="na">format_id=</span><span class="s">&quot;urn:taxii.mitre.org:query:default:1.0&quot;</span><span class="nt">&gt;</span>
<span class="lineno"> 9</span>       <span class="nt">&lt;tdq:Default_Query</span> <span class="na">targeting_expression_id=</span><span class="s">&quot;urn:stix.mitre.org:xml:1.1.1&quot;</span><span class="nt">&gt;</span>
<span class="lineno">10</span>         <span class="nt">&lt;tdq:Criteria</span> <span class="na">operator=</span><span class="s">&quot;AND&quot;</span><span class="nt">&gt;</span>
<span class="lineno">11</span>           <span class="nt">&lt;tdq:Criterion</span> <span class="na">negate=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<span class="lineno">12</span>             <span class="nt">&lt;tdq:Target&gt;</span>**/Simple_Hash_Value<span class="nt">&lt;/tdq:Target&gt;</span>
<span class="lineno">13</span>             <span class="nt">&lt;tdq:Test</span> <span class="na">capability_id=</span><span class="s">&quot;urn:taxii.mitre.org:query:capability:core-1&quot;</span> <span class="na">relationship=</span><span class="s">&quot;equals&quot;</span><span class="nt">&gt;</span>
<span class="lineno">14</span>               <span class="nt">&lt;tdq:Parameter</span> <span class="na">name=</span><span class="s">&quot;match_type&quot;</span><span class="nt">&gt;</span>case_insensitive_string<span class="nt">&lt;/tdq:Parameter&gt;</span>
<span class="lineno">15</span>               <span class="nt">&lt;tdq:Parameter</span> <span class="na">name=</span><span class="s">&quot;value&quot;</span><span class="nt">&gt;</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<span class="nt">&lt;/tdq:Parameter&gt;</span>
<span class="lineno">16</span>             <span class="nt">&lt;/tdq:Test&gt;</span>
<span class="lineno">17</span>           <span class="nt">&lt;/tdq:Criterion&gt;</span>
<span class="lineno">18</span>         <span class="nt">&lt;/tdq:Criteria&gt;</span>
<span class="lineno">19</span>       <span class="nt">&lt;/tdq:Default_Query&gt;</span>
<span class="lineno">20</span>     <span class="nt">&lt;/taxii_11:Query&gt;</span>
<span class="lineno">21</span>   <span class="nt">&lt;/taxii_11:Poll_Parameters&gt;</span>
<span class="lineno">22</span> <span class="nt">&lt;/taxii_11:Poll_Request&gt;</span></code></pre></div>

<p><a href="file-hash-rep-poll-request.xml">XML Source</a></p>

<h4 id="poll-request---python">Poll Request - Python</h4>

<p>Python code to create the Poll Request.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">import</span> <span class="nn">libtaxii.taxii_default_query</span> <span class="kn">as</span> <span class="nn">tdq</span>
<span class="lineno"> 2</span> <span class="kn">import</span> <span class="nn">libtaxii.messages_11</span> <span class="kn">as</span> <span class="nn">tm11</span>
<span class="lineno"> 3</span> <span class="kn">from</span> <span class="nn">libtaxii.common</span> <span class="kn">import</span> <span class="n">generate_message_id</span>
<span class="lineno"> 4</span> <span class="kn">from</span> <span class="nn">libtaxii.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span>
<span class="lineno"> 7</span> <span class="n">target</span> <span class="o">=</span> <span class="s">&#39;**/Simple_Hash_Value&#39;</span>
<span class="lineno"> 8</span> 
<span class="lineno"> 9</span> <span class="c"># Create the test portion of the query</span>
<span class="lineno">10</span> <span class="n">my_test</span> <span class="o">=</span> <span class="n">tdq</span><span class="o">.</span><span class="n">Test</span><span class="p">(</span><span class="n">capability_id</span> <span class="o">=</span> <span class="n">CM_CORE</span><span class="p">,</span>
<span class="lineno">11</span>                    <span class="n">relationship</span> <span class="o">=</span> <span class="n">R_EQUALS</span><span class="p">,</span>
<span class="lineno">12</span>                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="n">P_VALUE</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
<span class="lineno">13</span>                                  <span class="n">P_MATCH_TYPE</span><span class="p">:</span> <span class="s">&#39;case_insensitive_string&#39;</span><span class="p">}</span>
<span class="lineno">14</span>                    <span class="p">)</span>
<span class="lineno">15</span> 
<span class="lineno">16</span> <span class="c">#Put the test into a Criterion</span>
<span class="lineno">17</span> <span class="n">my_criterion</span> <span class="o">=</span> <span class="n">tdq</span><span class="o">.</span><span class="n">Criterion</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="n">my_test</span><span class="p">)</span>
<span class="lineno">18</span> 
<span class="lineno">19</span> <span class="c"># Put the Criterion into a Criteria</span>
<span class="lineno">20</span> <span class="n">my_criteria</span> <span class="o">=</span> <span class="n">tdq</span><span class="o">.</span><span class="n">Criteria</span><span class="p">(</span><span class="n">operator</span><span class="o">=</span><span class="n">OP_AND</span><span class="p">,</span>
<span class="lineno">21</span>                            <span class="n">criterion</span><span class="o">=</span><span class="p">[</span><span class="n">my_criterion</span><span class="p">],</span> 
<span class="lineno">22</span>                            <span class="n">criteria</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
<span class="lineno">23</span> 
<span class="lineno">24</span> <span class="c"># Create a query with the criteria</span>
<span class="lineno">25</span> <span class="n">my_query</span> <span class="o">=</span> <span class="n">tdq</span><span class="o">.</span><span class="n">DefaultQuery</span><span class="p">(</span><span class="n">CB_STIX_XML_111</span><span class="p">,</span> <span class="n">my_criteria</span><span class="p">)</span>
<span class="lineno">26</span> 
<span class="lineno">27</span> <span class="c"># Create a Poll Parameters that indicates</span>
<span class="lineno">28</span> <span class="c"># Only STIX 1.1.1 is accepted in response</span>
<span class="lineno">29</span> <span class="c"># and with the query created previously</span>
<span class="lineno">30</span> <span class="n">params</span> <span class="o">=</span> <span class="n">tm11</span><span class="o">.</span><span class="n">PollParameters</span><span class="p">(</span>
<span class="lineno">31</span>                 <span class="n">content_bindings</span> <span class="o">=</span> <span class="p">[</span><span class="n">tm11</span><span class="o">.</span><span class="n">ContentBinding</span><span class="p">(</span><span class="n">CB_STIX_XML_111</span><span class="p">)],</span>
<span class="lineno">32</span>                 <span class="n">query</span> <span class="o">=</span> <span class="n">my_query</span><span class="p">)</span>
<span class="lineno">33</span> 
<span class="lineno">34</span> <span class="n">poll_request</span> <span class="o">=</span> <span class="n">tm11</span><span class="o">.</span><span class="n">PollRequest</span><span class="p">(</span>
<span class="lineno">35</span>                     <span class="n">message_id</span> <span class="o">=</span> <span class="n">generate_message_id</span><span class="p">(),</span>
<span class="lineno">36</span>                     <span class="n">collection_name</span> <span class="o">=</span> <span class="s">&#39;file_hash_reputation&#39;</span><span class="p">,</span>
<span class="lineno">37</span>                     <span class="n">poll_parameters</span> <span class="o">=</span> <span class="n">params</span><span class="p">)</span>
<span class="lineno">38</span> 
<span class="lineno">39</span> <span class="k">print</span> <span class="n">poll_request</span><span class="o">.</span><span class="n">to_xml</span><span class="p">(</span><span class="n">pretty_print</span> <span class="o">=</span> <span class="bp">True</span><span class="p">)</span></code></pre></div>

<p><a href="file-hash-rep-poll-request.py">Python Source</a></p>

<h3 id="step-3---inbound-mapping"><a name="3"></a>Step 3 - Inbound Mapping</h3>

<p>The inbound mapping step is specific to each implementation&#39;s back end, requirements, and
other factors. While this TAXII Service Profile describes an inbound mapping for the database
table already described, real world implementers may make different choices based on factors
specific to their use case.</p>

<p>As described before, the md5_hash column was mapped to the Simple_Hash_Value STIX field.
Therefore, the targeting expression of <strong>**/Simple_Hash_Value</strong> is mapped to the database column <strong>md5_hash</strong>. 
Other service providers wishing to provide query capabilities on other hash types (e.g., SHA-1), 
could map <strong>**Simple_Hash_Value</strong> to other database fields that support those other hash types; or they could
rename md5_hash to <code>hash_value</code> and add a <code>hash_type</code> column to the database. </p>

<p>As a result the TAXII Query from the above Poll Request can be mapped into the following SQL
Query: <code>select * from file_hash_reputation_stixified where md5_hash = &#39;&lt;value&gt;&#39;</code>
(Recall that the equals operator in SQL is case insensitive).</p>

<p>One important thing to note is that the inbound mapping is not a dynamic, or &quot;runtime&quot; operation. Instead,
the mapping of a TAXII Query to backend storage happens when the code is built. In the case of this TAXII
Service Profile, there is a one-to-one mapping between a TAXII Query scope and backend field. Other implementations
may support more complex operations.</p>

<h3 id="step-4---database-query"><a name="4"></a>Step 4 - Database Query</h3>

<p>The inbound mapping is applied to the received TAXII Query, resulting in this SQL Statement:
<code>select * from file_hash_reputation where md5_hash = &#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</code>. 
<em>Note: Use prepared statements! SQL injection is the most common software weakness and if you don&#39;t use prepared statements your code is bad and you should feel bad.</em></p>

<p>Upon executing the query against the database, the following SQL result set is returned:</p>

<table><thead>
<tr>
<th>md5_hash</th>
<th>object_id (local part)</th>
<th>observable_id (local part)</th>
<th>confidence</th>
<th>confidence_timestamp</th>
<th>indicator_id (local part)</th>
<th>indicator_timestamp</th>
</tr>
</thead><tbody>
<tr>
<td>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</td>
<td>File-927731f2-cc2c-421c-a40e-dc6f4a6c75a4</td>
<td>Observable-45e3e64c-8438-441e-bc49-51e417466e29</td>
<td>High</td>
<td>2014-09-29T14:32:00.000000</td>
<td>Indicator-54baefc1-4742-4b40-ba83-afd51115015b</td>
<td>2014-09-29T14:32:00.000000</td>
</tr>
</tbody></table>

<p>This result set is used in the Outbound Mapping to generate the STIX response.</p>

<h3 id="step-5---outbound-mapping"><a name="5"></a>Step 5 - Outbound Mapping</h3>

<p>(This step might be overcome by the STIXification section). MARK FOR REMOVAL.</p>

<h3 id="step-6---poll-response"><a name="6"></a>Step 6 - Poll Response</h3>

<h4 id="poll-response---xml">Poll Response - XML</h4>

<p>The service provider returns a Poll Response, containing the results of the query made in the Poll Request.</p>

<div class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="lineno"> 1</span> <span class="nt">&lt;taxii_11:Poll_Response</span>
<span class="lineno"> 2</span>     <span class="na">xmlns:taxii_11=</span><span class="s">&quot;http://taxii.mitre.org/messages/taxii_xml_binding-1.1&quot;</span>
<span class="lineno"> 3</span>     <span class="na">in_response_to=</span><span class="s">&quot;1234&quot;</span> <span class="na">collection_name=</span><span class="s">&quot;file_hash_reputation&quot;</span> <span class="na">more=</span><span class="s">&quot;false&quot;</span> <span class="na">result_part_number=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="lineno"> 4</span>     <span class="nt">&lt;taxii_11:Content_Block&gt;</span>
<span class="lineno"> 5</span>         <span class="nt">&lt;taxii_11:Content_Binding</span> <span class="na">binding_id=</span><span class="s">&quot;urn:stix.mitre.org:xml:1.1.1&quot;</span><span class="nt">/&gt;</span>
<span class="lineno"> 6</span>         <span class="nt">&lt;taxii_11:Content&gt;</span>
<span class="lineno"> 7</span>             <span class="nt">&lt;stix:STIX_Package</span> <span class="na">xmlns:cyboxCommon=</span><span class="s">&quot;http://cybox.mitre.org/common-2&quot;</span>
<span class="lineno"> 8</span>                 <span class="na">xmlns:cybox=</span><span class="s">&quot;http://cybox.mitre.org/cybox-2&quot;</span>
<span class="lineno"> 9</span>                 <span class="na">xmlns:cyboxVocabs=</span><span class="s">&quot;http://cybox.mitre.org/default_vocabularies-2&quot;</span>
<span class="lineno">10</span>                 <span class="na">xmlns:FileObj=</span><span class="s">&quot;http://cybox.mitre.org/objects#FileObject-2&quot;</span>
<span class="lineno">11</span>                 <span class="na">xmlns:incident=</span><span class="s">&quot;http://stix.mitre.org/Incident-1&quot;</span>
<span class="lineno">12</span>                 <span class="na">xmlns:indicator=</span><span class="s">&quot;http://stix.mitre.org/Indicator-2&quot;</span>
<span class="lineno">13</span>                 <span class="na">xmlns:ttp=</span><span class="s">&quot;http://stix.mitre.org/TTP-1&quot;</span>
<span class="lineno">14</span>                 <span class="na">xmlns:stixCommon=</span><span class="s">&quot;http://stix.mitre.org/common-1&quot;</span>
<span class="lineno">15</span>                 <span class="na">xmlns:stixVocabs=</span><span class="s">&quot;http://stix.mitre.org/default_vocabularies-1&quot;</span>
<span class="lineno">16</span>                 <span class="na">xmlns:stix=</span><span class="s">&quot;http://stix.mitre.org/stix-1&quot;</span>
<span class="lineno">17</span>                 <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
<span class="lineno">18</span>                 <span class="na">xmlns:m4=</span><span class="s">&quot;urn:example.com:marks_malware_metadata_mart&quot;</span>
<span class="lineno">19</span>                 <span class="na">xsi:schemaLocation=</span><span class="s">&quot;  http://cybox.mitre.org/common-2 http://cybox.mitre.org/XMLSchema/common/2.1/cybox_common.xsd  http://cybox.mitre.org/cybox-2 http://cybox.mitre.org/XMLSchema/core/2.1/cybox_core.xsd  http://cybox.mitre.org/default_vocabularies-2 http://cybox.mitre.org/XMLSchema/default_vocabularies/2.1/cybox_default_vocabularies.xsd  http://cybox.mitre.org/objects#FileObject-2 http://cybox.mitre.org/XMLSchema/objects/File/2.1/File_Object.xsd  http://stix.mitre.org/Incident-1 http://stix.mitre.org/XMLSchema/incident/1.1.1/incident.xsd  http://stix.mitre.org/Indicator-2 http://stix.mitre.org/XMLSchema/indicator/2.1.1/indicator.xsd  http://stix.mitre.org/TTP-1 http://stix.mitre.org/XMLSchema/ttp/1.1.1/ttp.xsd  http://stix.mitre.org/common-1 http://stix.mitre.org/XMLSchema/common/1.1.1/stix_common.xsd  http://stix.mitre.org/default_vocabularies-1 http://stix.mitre.org/XMLSchema/default_vocabularies/1.1.1/stix_default_vocabularies.xsd  http://stix.mitre.org/stix-1 http://stix.mitre.org/XMLSchema/core/1.1.1/stix_core.xsd&quot;</span>
<span class="lineno">20</span>                 <span class="na">id=</span><span class="s">&quot;m4:Package-5d58cbc6-673e-4483-ab00-ec0bc78a2201&quot;</span> <span class="na">version=</span><span class="s">&quot;1.1.1&quot;</span>
<span class="lineno">21</span>                 <span class="na">timestamp=</span><span class="s">&quot;2014-09-30T17:03:53.325000+00:00&quot;</span><span class="nt">&gt;</span>
<span class="lineno">22</span>                 <span class="nt">&lt;stix:STIX_Header&gt;</span>
<span class="lineno">23</span>                     <span class="nt">&lt;stix:Title&gt;</span>File Hash Reputation for AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<span class="nt">&lt;/stix:Title&gt;</span>
<span class="lineno">24</span>                     <span class="nt">&lt;stix:Package_Intent</span> <span class="na">xsi:type=</span><span class="s">&quot;stixVocabs:PackageIntentVocab-1.0&quot;</span>
<span class="lineno">25</span>                         <span class="nt">&gt;</span>Indicators - Malware Artifacts<span class="nt">&lt;/stix:Package_Intent&gt;</span>
<span class="lineno">26</span>                     <span class="nt">&lt;stix:Information_Source&gt;</span>
<span class="lineno">27</span>                         <span class="nt">&lt;stixCommon:Identity</span> <span class="na">id=</span><span class="s">&quot;m4:Identity-ae112339-7f78-4ef4-b602-7246fb28229e&quot;</span><span class="nt">&gt;</span>
<span class="lineno">28</span>                             <span class="nt">&lt;stixCommon:Name&gt;</span>Mark&#39;s Malware Metadata Mart<span class="nt">&lt;/stixCommon:Name&gt;</span>
<span class="lineno">29</span>                         <span class="nt">&lt;/stixCommon:Identity&gt;</span>
<span class="lineno">30</span>                     <span class="nt">&lt;/stix:Information_Source&gt;</span>
<span class="lineno">31</span>                 <span class="nt">&lt;/stix:STIX_Header&gt;</span>
<span class="lineno">32</span>                 <span class="nt">&lt;stix:Indicators&gt;</span>
<span class="lineno">33</span>                     <span class="nt">&lt;stix:Indicator</span> <span class="na">id=</span><span class="s">&quot;m4:Indicator-54baefc1-4742-4b40-ba83-afd51115015b&quot;</span>
<span class="lineno">34</span>                         <span class="na">timestamp=</span><span class="s">&quot;2014-09-29T14:32:00&quot;</span> <span class="na">xsi:type=</span><span class="s">&quot;indicator:IndicatorType&quot;</span>
<span class="lineno">35</span>                         <span class="na">negate=</span><span class="s">&quot;false&quot;</span> <span class="na">version=</span><span class="s">&quot;2.1.1&quot;</span><span class="nt">&gt;</span>
<span class="lineno">36</span>                         <span class="nt">&lt;indicator:Title&gt;</span>File Hash Reputation<span class="nt">&lt;/indicator:Title&gt;</span>
<span class="lineno">37</span>                         <span class="nt">&lt;indicator:Observable</span>
<span class="lineno">38</span>                             <span class="na">id=</span><span class="s">&quot;m4:Observable-45e3e64c-8438-441e-bc49-51e417466e29&quot;</span><span class="nt">&gt;</span>
<span class="lineno">39</span>                             <span class="nt">&lt;cybox:Object</span> <span class="na">id=</span><span class="s">&quot;m4:File-8835d32f-14e0-4b32-8c19-85986a56e3ff&quot;</span><span class="nt">&gt;</span>
<span class="lineno">40</span>                                 <span class="nt">&lt;cybox:Properties</span> <span class="na">xsi:type=</span><span class="s">&quot;FileObj:FileObjectType&quot;</span><span class="nt">&gt;</span>
<span class="lineno">41</span>                                     <span class="nt">&lt;FileObj:Hashes&gt;</span>
<span class="lineno">42</span>                                         <span class="nt">&lt;cyboxCommon:Hash&gt;</span>
<span class="lineno">43</span>                                             <span class="nt">&lt;cyboxCommon:Type</span> <span class="na">condition=</span><span class="s">&quot;Equals&quot;</span>
<span class="lineno">44</span>                                                 <span class="na">xsi:type=</span><span class="s">&quot;cyboxVocabs:HashNameVocab-1.0&quot;</span>
<span class="lineno">45</span>                                                 <span class="nt">&gt;</span>MD5<span class="nt">&lt;/cyboxCommon:Type&gt;</span>
<span class="lineno">46</span>                                             <span class="nt">&lt;cyboxCommon:Simple_Hash_Value</span> <span class="na">condition=</span><span class="s">&quot;Equals&quot;</span>
<span class="lineno">47</span>                                                 <span class="nt">&gt;</span>AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA<span class="nt">&lt;/cyboxCommon:Simple_Hash_Value&gt;</span>
<span class="lineno">48</span>                                         <span class="nt">&lt;/cyboxCommon:Hash&gt;</span>
<span class="lineno">49</span>                                     <span class="nt">&lt;/FileObj:Hashes&gt;</span>
<span class="lineno">50</span>                                 <span class="nt">&lt;/cybox:Properties&gt;</span>
<span class="lineno">51</span>                             <span class="nt">&lt;/cybox:Object&gt;</span>
<span class="lineno">52</span>                         <span class="nt">&lt;/indicator:Observable&gt;</span>
<span class="lineno">53</span>                         <span class="nt">&lt;indicator:Indicated_TTP&gt;</span>
<span class="lineno">54</span>                             <span class="nt">&lt;stixCommon:Confidence</span> <span class="na">timestamp=</span><span class="s">&quot;2014-09-29T14:32:00&quot;</span><span class="nt">&gt;</span>
<span class="lineno">55</span>                                 <span class="nt">&lt;stixCommon:Value</span> <span class="na">xsi:type=</span><span class="s">&quot;stixVocabs:HighMediumLowVocab-1.0&quot;</span>
<span class="lineno">56</span>                                     <span class="nt">&gt;</span>High<span class="nt">&lt;/stixCommon:Value&gt;</span>
<span class="lineno">57</span>                             <span class="nt">&lt;/stixCommon:Confidence&gt;</span>
<span class="lineno">58</span>                             <span class="nt">&lt;stixCommon:TTP</span> <span class="na">idref=</span><span class="s">&quot;m4:ttp-d539bb85-9363-4814-83c8-fa9975045686&quot;</span>
<span class="lineno">59</span>                                 <span class="na">timestamp=</span><span class="s">&quot;2014-09-30T15:56:27+00:00&quot;</span> <span class="na">xsi:type=</span><span class="s">&quot;ttp:TTPType&quot;</span>
<span class="lineno">60</span>                                 <span class="na">version=</span><span class="s">&quot;1.1.1&quot;</span><span class="nt">/&gt;</span>
<span class="lineno">61</span>                         <span class="nt">&lt;/indicator:Indicated_TTP&gt;</span>
<span class="lineno">62</span>                     <span class="nt">&lt;/stix:Indicator&gt;</span>
<span class="lineno">63</span>                 <span class="nt">&lt;/stix:Indicators&gt;</span>
<span class="lineno">64</span>                 <span class="nt">&lt;stix:TTPs&gt;</span>
<span class="lineno">65</span>                     <span class="nt">&lt;stix:TTP</span> <span class="na">id=</span><span class="s">&quot;m4:ttp-d539bb85-9363-4814-83c8-fa9975045686&quot;</span>
<span class="lineno">66</span>                         <span class="na">timestamp=</span><span class="s">&quot;2014-09-30T15:56:27+00:00&quot;</span> <span class="na">xsi:type=</span><span class="s">&quot;ttp:TTPType&quot;</span> <span class="na">version=</span><span class="s">&quot;1.1.1&quot;</span><span class="nt">&gt;</span>
<span class="lineno">67</span>                         <span class="nt">&lt;ttp:Title&gt;</span>Malicious File<span class="nt">&lt;/ttp:Title&gt;</span>
<span class="lineno">68</span>                     <span class="nt">&lt;/stix:TTP&gt;</span>
<span class="lineno">69</span>                 <span class="nt">&lt;/stix:TTPs&gt;</span>
<span class="lineno">70</span>             <span class="nt">&lt;/stix:STIX_Package&gt;</span>
<span class="lineno">71</span>         <span class="nt">&lt;/taxii_11:Content&gt;</span>
<span class="lineno">72</span>     <span class="nt">&lt;/taxii_11:Content_Block&gt;</span>
<span class="lineno">73</span> <span class="nt">&lt;/taxii_11:Poll_Response&gt;</span></code></pre></div>

<p><a href="file-hash-rep-poll-response.xml">XML Source</a></p>

<h4 id="poll-response---python">Poll Response - Python</h4>

<p>Python code to create the Poll Response.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">import</span> <span class="nn">libtaxii.messages_11</span> <span class="kn">as</span> <span class="nn">tm11</span>
<span class="lineno"> 2</span> <span class="kn">from</span> <span class="nn">libtaxii.common</span> <span class="kn">import</span> <span class="n">generate_message_id</span>
<span class="lineno"> 3</span> <span class="kn">from</span> <span class="nn">libtaxii.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno"> 4</span> 
<span class="lineno"> 5</span> <span class="kn">from</span> <span class="nn">stix.core</span> <span class="kn">import</span> <span class="n">STIXPackage</span><span class="p">,</span> <span class="n">STIXHeader</span>
<span class="lineno"> 6</span> <span class="kn">from</span> <span class="nn">stix.common</span> <span class="kn">import</span> <span class="n">InformationSource</span><span class="p">,</span> <span class="n">Identity</span>
<span class="lineno"> 7</span> <span class="kn">from</span> <span class="nn">stix.indicator</span> <span class="kn">import</span> <span class="n">Indicator</span>
<span class="lineno"> 8</span> <span class="kn">from</span> <span class="nn">stix.ttp</span> <span class="kn">import</span> <span class="n">TTP</span>
<span class="lineno"> 9</span> <span class="kn">from</span> <span class="nn">stix.utils</span> <span class="kn">import</span> <span class="n">set_id_namespace</span> <span class="k">as</span> <span class="n">stix_sin</span>
<span class="lineno">10</span> <span class="kn">from</span> <span class="nn">cybox.common</span> <span class="kn">import</span> <span class="n">Hash</span>
<span class="lineno">11</span> <span class="kn">from</span> <span class="nn">cybox.objects.file_object</span> <span class="kn">import</span> <span class="n">File</span>
<span class="lineno">12</span> <span class="kn">from</span> <span class="nn">cybox.utils</span> <span class="kn">import</span> <span class="n">set_id_namespace</span> <span class="k">as</span> <span class="n">cybox_sin</span><span class="p">,</span> <span class="n">Namespace</span>
<span class="lineno">13</span> 
<span class="lineno">14</span> <span class="c"># &quot;hardcoded&quot; values</span>
<span class="lineno">15</span> <span class="n">ns</span> <span class="o">=</span> <span class="s">&quot;urn:example.com:marks_malware_metadata_mart&quot;</span>
<span class="lineno">16</span> <span class="n">ns_alias</span> <span class="o">=</span> <span class="s">&quot;m4&quot;</span>
<span class="lineno">17</span> 
<span class="lineno">18</span> <span class="c"># Set the STIX ID Namespace</span>
<span class="lineno">19</span> <span class="n">stix_namespace</span> <span class="o">=</span> <span class="p">{</span><span class="n">ns</span><span class="p">:</span> <span class="n">ns_alias</span><span class="p">}</span>
<span class="lineno">20</span> <span class="n">stix_sin</span><span class="p">(</span><span class="n">stix_namespace</span><span class="p">)</span>
<span class="lineno">21</span> 
<span class="lineno">22</span> <span class="c"># Set the CybOX ID Namespace</span>
<span class="lineno">23</span> <span class="n">cybox_namespace</span> <span class="o">=</span> <span class="n">Namespace</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">ns_alias</span><span class="p">)</span>
<span class="lineno">24</span> <span class="n">cybox_sin</span><span class="p">(</span><span class="n">cybox_namespace</span><span class="p">)</span>
<span class="lineno">25</span> 
<span class="lineno">26</span> <span class="n">ttp_id</span> <span class="o">=</span> <span class="s">&#39;ttp-d539bb85-9363-4814-83c8-fa9975045686&#39;</span>
<span class="lineno">27</span> <span class="n">ttp_timestamp</span> <span class="o">=</span> <span class="s">&#39;2014-09-30T15:56:27.000000+00:00&#39;</span>
<span class="lineno">28</span> 
<span class="lineno">29</span> <span class="c"># &quot;database values&quot;</span>
<span class="lineno">30</span> <span class="n">md5_hash</span> <span class="o">=</span> <span class="s">&#39;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&#39;</span>
<span class="lineno">31</span> <span class="n">object_id</span> <span class="o">=</span> <span class="s">&#39;File-927731f2-cc2c-421c-a40e-dc6f4a6c75a4&#39;</span>
<span class="lineno">32</span> <span class="n">observable_id</span> <span class="o">=</span> <span class="s">&#39;Observable-45e3e64c-8438-441e-bc49-51e417466e29&#39;</span>
<span class="lineno">33</span> <span class="n">confidence</span> <span class="o">=</span> <span class="s">&#39;High&#39;</span>
<span class="lineno">34</span> <span class="n">confidence_timestamp</span> <span class="o">=</span> <span class="s">&#39;2014-09-29T14:32:00.000000&#39;</span>
<span class="lineno">35</span> <span class="n">indicator_id</span> <span class="o">=</span> <span class="s">&#39;Indicator-54baefc1-4742-4b40-ba83-afd51115015b&#39;</span>
<span class="lineno">36</span> <span class="n">indicator_timestamp</span> <span class="o">=</span> <span class="s">&#39;2014-09-29T14:32:00.000000&#39;</span>
<span class="lineno">37</span> 
<span class="lineno">38</span> <span class="c"># Code to create the STIX Package</span>
<span class="lineno">39</span> <span class="n">sp</span> <span class="o">=</span> <span class="n">STIXPackage</span><span class="p">()</span>
<span class="lineno">40</span> <span class="n">sp</span><span class="o">.</span><span class="n">stix_header</span> <span class="o">=</span> <span class="n">STIXHeader</span><span class="p">()</span>
<span class="lineno">41</span> <span class="n">sp</span><span class="o">.</span><span class="n">stix_header</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;File Hash Reputation for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">md5_hash</span>
<span class="lineno">42</span> <span class="n">sp</span><span class="o">.</span><span class="n">stix_header</span><span class="o">.</span><span class="n">add_package_intent</span><span class="p">(</span><span class="s">&quot;Indicators - Malware Artifacts&quot;</span><span class="p">)</span>
<span class="lineno">43</span> <span class="n">sp</span><span class="o">.</span><span class="n">stix_header</span><span class="o">.</span><span class="n">information_source</span> <span class="o">=</span> <span class="n">InformationSource</span><span class="p">()</span>
<span class="lineno">44</span> <span class="n">sp</span><span class="o">.</span><span class="n">stix_header</span><span class="o">.</span><span class="n">information_source</span><span class="o">.</span><span class="n">identity</span> <span class="o">=</span> <span class="n">Identity</span><span class="p">()</span>
<span class="lineno">45</span> <span class="n">sp</span><span class="o">.</span><span class="n">stix_header</span><span class="o">.</span><span class="n">information_source</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Mark&#39;s Malware Metadata Mart&quot;</span>
<span class="lineno">46</span> 
<span class="lineno">47</span> <span class="n">file_hash</span> <span class="o">=</span> <span class="n">Hash</span><span class="p">(</span><span class="n">hash_value</span><span class="o">=</span><span class="n">md5_hash</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="s">&#39;MD5&#39;</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="lineno">48</span> <span class="n">file_hash</span><span class="o">.</span><span class="n">type_</span><span class="o">.</span><span class="n">condition</span> <span class="o">=</span> <span class="s">&quot;Equals&quot;</span>
<span class="lineno">49</span> 
<span class="lineno">50</span> <span class="n">file_obj</span> <span class="o">=</span> <span class="n">File</span><span class="p">()</span>
<span class="lineno">51</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">id_</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns_alias</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">object_id</span><span class="p">)</span>
<span class="lineno">52</span> <span class="n">file_obj</span><span class="o">.</span><span class="n">add_hash</span><span class="p">(</span><span class="n">file_hash</span><span class="p">)</span>
<span class="lineno">53</span> 
<span class="lineno">54</span> <span class="n">indicator</span> <span class="o">=</span> <span class="n">Indicator</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;File Hash Reputation&quot;</span><span class="p">,</span>
<span class="lineno">55</span>                       <span class="n">id_</span><span class="o">=</span><span class="p">(</span><span class="n">ns_alias</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">indicator_id</span><span class="p">),</span>
<span class="lineno">56</span>                       <span class="n">timestamp</span><span class="o">=</span><span class="n">indicator_timestamp</span><span class="p">)</span>
<span class="lineno">57</span> <span class="n">indicator</span><span class="o">.</span><span class="n">indicator_type</span> <span class="o">=</span> <span class="s">&quot;File Hash Reputation&quot;</span>
<span class="lineno">58</span> <span class="n">indicator</span><span class="o">.</span><span class="n">add_observable</span><span class="p">(</span><span class="n">file_obj</span><span class="p">)</span>
<span class="lineno">59</span> <span class="n">indicator</span><span class="o">.</span><span class="n">observables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id_</span> <span class="o">=</span> <span class="n">ns_alias</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">observable_id</span>
<span class="lineno">60</span> 
<span class="lineno">61</span> <span class="n">ttp</span> <span class="o">=</span> <span class="n">TTP</span><span class="p">()</span>
<span class="lineno">62</span> <span class="n">ttp</span><span class="o">.</span><span class="n">id_</span> <span class="o">=</span> <span class="n">ns_alias</span> <span class="o">+</span> <span class="s">&#39;:&#39;</span> <span class="o">+</span> <span class="n">ttp_id</span>
<span class="lineno">63</span> <span class="n">ttp</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">ttp_timestamp</span>
<span class="lineno">64</span> <span class="n">ttp</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Malicious File&quot;</span>
<span class="lineno">65</span> 
<span class="lineno">66</span> <span class="n">indicator</span><span class="o">.</span><span class="n">add_indicated_ttp</span><span class="p">(</span><span class="n">TTP</span><span class="p">(</span><span class="n">idref</span><span class="o">=</span><span class="n">ttp</span><span class="o">.</span><span class="n">id_</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">ttp</span><span class="o">.</span><span class="n">timestamp</span><span class="p">))</span>
<span class="lineno">67</span> <span class="n">indicator</span><span class="o">.</span><span class="n">indicated_ttps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="n">confidence</span>
<span class="lineno">68</span> <span class="n">indicator</span><span class="o">.</span><span class="n">indicated_ttps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">confidence</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">confidence_timestamp</span>
<span class="lineno">69</span> 
<span class="lineno">70</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_indicator</span><span class="p">(</span><span class="n">indicator</span><span class="p">)</span>
<span class="lineno">71</span> <span class="n">sp</span><span class="o">.</span><span class="n">add_ttp</span><span class="p">(</span><span class="n">ttp</span><span class="p">)</span>
<span class="lineno">72</span> 
<span class="lineno">73</span> <span class="n">stix_xml</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">to_xml</span><span class="p">()</span>
<span class="lineno">74</span> 
<span class="lineno">75</span> <span class="n">poll_response</span> <span class="o">=</span> <span class="n">tm11</span><span class="o">.</span><span class="n">PollResponse</span><span class="p">(</span><span class="n">message_id</span><span class="o">=</span><span class="n">generate_message_id</span><span class="p">(),</span>
<span class="lineno">76</span>                                   <span class="n">in_response_to</span><span class="o">=</span><span class="s">&quot;1234&quot;</span><span class="p">,</span>
<span class="lineno">77</span>                                   <span class="n">collection_name</span><span class="o">=</span><span class="s">&#39;file_hash_reputation&#39;</span><span class="p">)</span>
<span class="lineno">78</span> <span class="n">cb</span> <span class="o">=</span> <span class="n">tm11</span><span class="o">.</span><span class="n">ContentBlock</span><span class="p">(</span><span class="n">content_binding</span><span class="o">=</span><span class="n">CB_STIX_XML_111</span><span class="p">,</span>
<span class="lineno">79</span>                        <span class="n">content</span><span class="o">=</span><span class="n">stix_xml</span><span class="p">)</span>
<span class="lineno">80</span> <span class="n">poll_response</span><span class="o">.</span><span class="n">content_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
<span class="lineno">81</span> <span class="k">print</span> <span class="n">poll_response</span><span class="o">.</span><span class="n">to_xml</span><span class="p">(</span><span class="n">pretty_print</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></code></pre></div>

<p><a href="file-hash-rep-poll-response.py">Python Source</a></p>

<h3 id="step-7---parse-response"><a name="7"></a>Step 7 - Parse Response</h3>

<p>The information recipient parses the response and &quot;makes a decision&quot; (read: prints a statement) about whether the 
file is safe to open
 based on the reputation response. While this step is not performed by the service provider, 
it is useful for completeness so it is included in this TAXII Service profile. </p>

<h3 id="parse-response---python---do-not-read-this-yet,-it-needs-to-be-updated">Parse Response - Python - DO NOT READ THIS YET, IT NEEDS TO BE UPDATED</h3>

<p>Python code to parse the response using the stix and libtaxii python libraries. It reads from a file
instead of from the network.</p>

<div class="highlight"><pre><code class="language-python" data-lang="python"><span class="lineno"> 1</span> <span class="kn">import</span> <span class="nn">libtaxii.messages_11</span> <span class="kn">as</span> <span class="nn">tm11</span>
<span class="lineno"> 2</span> <span class="kn">from</span> <span class="nn">libtaxii.constants</span> <span class="kn">import</span> <span class="o">*</span>
<span class="lineno"> 3</span> <span class="kn">from</span> <span class="nn">stix.core</span> <span class="kn">import</span> <span class="n">STIXPackage</span>
<span class="lineno"> 4</span> <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="lineno"> 5</span> 
<span class="lineno"> 6</span> <span class="n">poll_response</span> <span class="o">=</span> <span class="s">&#39;file-hash-rep-poll-response.xml&#39;</span>
<span class="lineno"> 7</span> <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">poll_response</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
<span class="lineno"> 8</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">tm11</span><span class="o">.</span><span class="n">get_message_from_xml</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="lineno"> 9</span> 
<span class="lineno">10</span> <span class="c"># Iterate over the content blocks</span>
<span class="lineno">11</span> <span class="k">for</span> <span class="n">content_block</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">content_blocks</span><span class="p">:</span>
<span class="lineno">12</span>     <span class="k">if</span> <span class="n">content_block</span><span class="o">.</span><span class="n">content_binding</span><span class="o">.</span><span class="n">binding_id</span> <span class="o">!=</span> <span class="n">CB_STIX_XML_111</span><span class="p">:</span>
<span class="lineno">13</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Something other than STIX 1.1.1 was attempted!&#39;</span><span class="p">)</span>
<span class="lineno">14</span>     <span class="n">package</span> <span class="o">=</span> <span class="n">STIXPackage</span><span class="o">.</span><span class="n">from_xml</span><span class="p">(</span><span class="n">StringIO</span><span class="p">(</span><span class="n">content_block</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
<span class="lineno">15</span>     <span class="n">shv</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">indicators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">observable</span><span class="o">.</span><span class="n">object_</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">hashes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">simple_hash_value</span>
<span class="lineno">16</span>     <span class="c"># You could check the hash value to make sure it&#39;s what you queried</span>
<span class="lineno">17</span>     <span class="n">confidence</span> <span class="o">=</span> <span class="c"># TODO: Update this</span>
<span class="lineno">18</span> 
<span class="lineno">19</span>     <span class="c"># &quot;Make a choice&quot; depending on the confidence of the file</span>
<span class="lineno">20</span>     <span class="k">if</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
<span class="lineno">21</span>         <span class="k">print</span> <span class="s">&quot;DO NOT OPEN THE FILE&quot;</span>
<span class="lineno">22</span>     <span class="k">elif</span> <span class="n">confidence</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">:</span>
<span class="lineno">23</span>         <span class="k">print</span> <span class="s">&quot;THINK TWICE ABOUT OPENING THE FILE&quot;</span>
<span class="lineno">24</span>     <span class="k">else</span><span class="p">:</span>
<span class="lineno">25</span>         <span class="k">print</span> <span class="s">&quot;OPEN FILE AT YOUR OWN RISK&quot;</span></code></pre></div>

<p><a href="file-hash-rep-parse-response.py">Python Source</a></p>

<h3 id="conclusion">Conclusion</h3>

<p>Hopefully that helps!</p>

<p>This is brand new documentation. If there is something missing, something that could be 
explained better, or something you&#39;d like to see added, please send a message to 
 <a href="mailto:taxii@mitre.org">taxii@mitre.org</a> and we&#39;ll be happy to hear you&#39;re feedback!</p>

    </div>

    <div id="footer">
  <hr />
  <div class="container">
    <p class="text-muted">
      Copyright 2015 The MITRE Corporation. <a href="http://taxii.mitre.org/about/termsofuse.html">Terms of Use</a>
    </p>
  </div>
</div>

<!-- jQuery JS -->
<script src="/js/jquery.min.js"></script>

<!-- bootstrap JS -->
<script src="/js/bootstrap.min.js"></script>

<!-- typeahead JS -->
<script src="/js/typeahead.min.js"></script>

<!-- Custom JS -->
<script src="/js/main.js"></script>

  </body>
</html>
